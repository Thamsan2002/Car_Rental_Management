@model Car_Rental_Management.ViewModel.BookingViewmodel
@{
    ViewData["Title"] = "Book Car";
}

<h2>Booking for @Model.CarMake @Model.CarModel</h2>

<div class="row">
    <div class="col-md-6">
        <img src="@Model.CarImage" class="img-fluid mb-3" />
        <p><strong>Color:</strong> @Model.CarColor</p>
        <p><strong>Price/Day:</strong> LKR @Model.CarPricePerDay:N0</p>
    </div>

    <div class="col-md-6">
        <form asp-action="Booking" method="post">
            <input type="hidden" asp-for="CustomerId" />
            <input type="hidden" asp-for="CarId" />

            <div class="mb-3">
                <label>Booking Type</label><br />
                <input type="radio" asp-for="BookingType" value="WithoutDriver" checked onchange="toggleDriverSelect()" /> Without Driver
                <input type="radio" asp-for="BookingType" value="WithDriver" onchange="toggleDriverSelect()" /> With Driver
            </div>

            <div class="mb-3" id="driverSelectDiv" style="display:none;">
                <label>Select Driver</label>
                <select asp-for="DriverId" class="form-control" id="driverSelect" onchange="calculateTotal()">
                    <option value="">Select</option>
                    @* @foreach (var driver in Model.Drivers)
                    {
                        <option value="@driver.Id" data-fee="@driver.FeePerDay">@driver.Name - LKR @driver.FeePerDay:N0 per day</option>
                    } *@
                </select>
            </div>

            <div class="mb-3">
                <label>Start Date</label>
                <input asp-for="StartDate" type="date" class="form-control" id="startDate" onchange="calculateTotal()" />
            </div>

            <div class="mb-3">
                <label>End Date</label>
                <input asp-for="EndDate" type="date" class="form-control" id="endDate" onchange="calculateTotal()" />
            </div>

            <div class="mb-3">
                <label>Total Price</label>
                <input asp-for="TotalPrice" type="text" class="form-control" id="totalPrice" readonly />
            </div>

            <button type="submit" class="btn btn-success">Confirm Booking</button>
            <a asp-action="Index" asp-controller="Home" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function toggleDriverSelect() {
            const withDriver = document.querySelector('input[name="BookingType"]:checked').value === "WithDriver";
            document.getElementById('driverSelectDiv').style.display = withDriver ? 'block' : 'none';
            calculateTotal();
        }

        function calculateTotal() {
            const carPrice = @Model.CarPricePerDay;
            const startDateVal = document.getElementById('startDate').value;
            const endDateVal = document.getElementById('endDate').value;
            const startDate = startDateVal ? new Date(startDateVal) : null;
            const endDate = endDateVal ? new Date(endDateVal) : null;

            let totalDays = 0;
            if (startDate && endDate && endDate >= startDate) {
                totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            }

            let driverFee = 0;
            if (document.querySelector('input[name="BookingType"]:checked').value === "WithDriver") {
                const driverSelect = document.getElementById('driverSelect');
                const selectedOption = driverSelect.options[driverSelect.selectedIndex];
                driverFee = selectedOption ? parseFloat(selectedOption.getAttribute('data-fee') || 0) : 0;
            }

            const total = (carPrice + driverFee) * totalDays;
            document.getElementById('totalPrice').value = total.toLocaleString('en-US', { style: 'currency', currency: 'LKR', minimumFractionDigits: 0 });
        }

        document.addEventListener('DOMContentLoaded', function() {
            calculateTotal();
        });
    </script>
}
