@model Car_Rental_Management.ViewModel.BookingViewmodel
@{
    ViewData["Title"] = "Book Car";
}

<h2>Booking for @Model.CarMake @Model.CarModel</h2>

<div class="row">
    <div class="col-md-6">
        <img src="@Model.CarImage" class="img-fluid mb-3" />
        <p><strong>Color:</strong> @Model.CarColor</p>
        <p><strong>Price/Day:</strong> LKR @Model.CarPricePerDay:N0</p>
    </div>

    <div class="col-md-6">
        <form asp-action="Create" method="post">
            <input type="hidden" asp-for="CustomerId" />
            <input type="hidden" asp-for="CarId" />
            <input type="hidden" asp-for="CarMake" />
            <input type="hidden" asp-for="CarModel" />
            <input type="hidden" asp-for="CarColor" />
            <input type="hidden" asp-for="CarImage" />
            <input type="hidden" asp-for="CarPricePerDay" />
            <input type="hidden" asp-for="TotalPrice" id="hiddenTotalPrice" />
            <input type="hidden" asp-for="DriverFee" id="hiddenDriverFee" />

            <div class="mb-3">
                <label>Booking Type</label><br />
                <input type="radio" asp-for="BookingType" value="WithoutDriver" checked onchange="calculateTotal()" /> Without Driver
                <input type="radio" asp-for="BookingType" value="WithDriver" onchange="calculateTotal()" /> With Driver (+ LKR 2000/day)
            </div>

            <div class="mb-3">
                <label>Start Date</label>
                <input asp-for="StartDate" type="date" class="form-control" id="startDate"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")" onchange="calculateTotal()" />
            </div>

            <div class="mb-3">
                <label>End Date</label>
                <input asp-for="EndDate" type="date" class="form-control" id="endDate"
                       min="@DateTime.Today.ToString("yyyy-MM-dd")" onchange="calculateTotal()" />
            </div>

            <div class="mb-3" id="driverFeeDiv" style="display:none;">
                <label>Driver Fee</label>
                <input type="text" class="form-control" id="driverFee" readonly />
            </div>

            <div class="mb-3">
                <label>Total Price</label>
                <input type="text" class="form-control" id="totalPrice" readonly />
            </div>

            <button type="submit" class="btn btn-success">Confirm Booking</button>
            <a asp-action="Index" asp-controller="Home" class="btn btn-secondary">Cancel</a>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        function calculateTotal() {
            const carPrice = @Model.CarPricePerDay;
            const driverPricePerDay = 2000;

            const startDateVal = document.getElementById('startDate').value;
            const endDateVal = document.getElementById('endDate').value;
            const startDate = startDateVal ? new Date(startDateVal) : null;
            const endDate = endDateVal ? new Date(endDateVal) : null;

            let totalDays = 0;
            if (startDate && endDate && endDate >= startDate) {
                totalDays = Math.ceil((endDate - startDate) / (1000*60*60*24)) + 1;
            }

            let driverFeeTotal = 0;
            if (document.querySelector('input[name="BookingType"]:checked').value === "WithDriver") {
                driverFeeTotal = driverPricePerDay * totalDays;
                document.getElementById('driverFeeDiv').style.display = 'block';
            } else {
                document.getElementById('driverFeeDiv').style.display = 'none';
            }

            let total = (carPrice * totalDays) + driverFeeTotal;

            document.getElementById('driverFee').value = "LKR " + driverFeeTotal.toLocaleString();
            document.getElementById('totalPrice').value = "LKR " + total.toLocaleString();

            // Hidden fields for controller binding
            document.getElementById('hiddenTotalPrice').value = total;
            document.getElementById('hiddenDriverFee').value = driverFeeTotal;
        }

        document.addEventListener('DOMContentLoaded', calculateTotal);
    </script>
}
